# Caddyfile - DeBrief
# Proxy reverso para Frontend e Backend
# Caddy está em network_mode: host, então escuta diretamente na porta 2022

:2022 {
    # Compressão automática
    encode zstd gzip

    # Proxy para API backend (/api/*)
    @api {
        path /api/*
    }
    handle @api {
        # Backend está em network_mode: host, escutando na porta 8000
        # Caddy também está em network_mode: host, então pode acessar localhost:8000
        reverse_proxy localhost:8000 {
            # Headers para proxy
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            
            # Timeouts
            transport http {
                dial_timeout 10s
                response_header_timeout 60s
            }
        }
    }

    # Proxy para Frontend (tudo mais)
    # Frontend está na rede Docker, precisa descobrir IP do container
    handle {
        # Tentar acessar frontend via IP do container na rede bridge
        # Se Caddy também estiver em network_mode: host, precisa usar IP do container frontend
        reverse_proxy 172.19.0.2:80 {
            # Headers para proxy
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    # Logs
    log {
        output stdout
        format console
    }
}

