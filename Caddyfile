# Caddyfile - DeBrief
# Proxy reverso para Frontend e Backend
# Caddy escuta na porta 2022 diretamente (network_mode: host)

:2022 {
    # Compressão automática
    encode zstd gzip

    # Proxy para API backend (/api/*)
    @api {
        path /api/*
    }
    handle @api {
        # Backend está em network_mode: host, então acessa via 127.0.0.1:8000 (IPv4)
        # Usar 127.0.0.1 em vez de localhost para evitar tentativa de IPv6
        # Backend tem rotas com prefixo /api, então fazer proxy direto
        reverse_proxy 127.0.0.1:8000 {
            # Headers para proxy
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            
            # Timeouts
            transport http {
                dial_timeout 10s
                response_header_timeout 60s
            }
        }
    }

    # Proxy para Frontend (tudo mais)
    # Frontend está na rede Docker, então usa o nome do serviço
    handle {
        reverse_proxy debrief-frontend:80 {
            # Headers para proxy
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
        }
    }

    # Logs
    log {
        output stdout
        format console
    }
}

